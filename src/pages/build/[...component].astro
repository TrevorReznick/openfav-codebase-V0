---
// src/pages/[...component].astro
import "@/styles/globals.css"
//import Layout from "@/layouts/Layout.astro"
import ThemeLayout from '@/layouts/Layout.astro';
import AppClient from '@/react/AppClient.tsx';

// Log the current page
console.log(`[page][${Astro.url.pathname}]`);

// Type definitions
interface ComponentParams {
  component?: string;
  [key: string]: string | undefined;
}

// Convert kebab-case to PascalCase for component names
const toPascalCase = (str: string): string => {
  const result = str
    .split('/')
    .map(part => 
      part
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join('')
    )
    .join('/');
  
  console.log(`[build/[component].astro] Converted "${str}" to "${result}"`);
  return result;
};

// Get component path and normalize it
const params = Astro.params as ComponentParams;
const originalPath = params.component?.toString() || 'home/HomePage';

// Default: convert kebab-case segments to PascalCase (directory structure preserved)
// But preserve known base directories in lowercase to match filesystem
const BASE_KEYS = ['auth', 'dashboard', 'examples', 'common', 'components', 'home'];
const parts = originalPath.split('/');
let componentPath = '';
if (parts.length > 0) {
  const first = parts[0];
  const baseMatch = BASE_KEYS.find((b) => b.toLowerCase() === first.toLowerCase());
  if (baseMatch) {
    const rest = parts.slice(1).join('/');
    const restPascal = rest ? toPascalCase(rest) : '';
    componentPath = restPascal ? `${baseMatch}/${restPascal}` : baseMatch;
  } else {
    componentPath = toPascalCase(originalPath);
  }
}

// Handle test-component specifically - always use examples/TestComponent
if (originalPath === 'test-component' || originalPath.endsWith('test-component')) {
  componentPath = 'examples/TestComponent';
}

const layoutType = componentPath.startsWith('admin/') ? 'dashboard' : 'default';

// Debug: Log component resolution
console.log('[build/[component].astro] Component resolution:', { 
  originalPath,
  componentPath,
  layoutType,
  expectedPath: `@/react/components/${componentPath}`,
  url: Astro.url.toString()
});
---

<ThemeLayout layout={layoutType}>
  <script data-component-path={componentPath}>
    // Import ThemeInjector for client-side theme management
    import { globalThemeInjector } from '@/react/lib/themeInjector.ts';

    // Client-side debug logs and theme management
    document.addEventListener('astro:page-load', () => {
      console.log('[build/[component].astro] Client-side execution started');
      console.log(`[build/[component].astro] Component path: ${document.currentScript?.getAttribute('data-component-path') || 'unknown'}`);

      // Initialize theme using ThemeInjector
      const initialTheme = globalThemeInjector.getTheme();
      console.log(`[theme-injector][component] Initialized with theme: ${initialTheme}`);

      // Listen for theme change events dispatched by ThemeInjector
      document.addEventListener('theme-change', (event) => {
        // @ts-ignore
        const { theme, resolvedTheme } = event.detail;
        console.log(`[theme-change][component] Theme changed to: ${theme} (resolved: ${resolvedTheme})`);
      });
    });
  </script>
  <AppClient 
    client:load
    componentPath={componentPath}
    wrapperProps={{
      astroUrl: Astro.url,
      astroParams: params,
      originalPath,
      debug: true
    }}
    wrapperDebug={true}
    showToaster={true}
  />
</ThemeLayout>
